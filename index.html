<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dobby AI Jobber - Advanced Career Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="icon" type="image/png" href="dobby-logo.png">
    <link rel="shortcut icon" type="image/png" href="dobby-logo.png">
    <link rel="apple-touch-icon" href="dobby-logo.png">
    
    <script src="https://unpkg.com/compromise"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border: #334155;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --glow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            z-index: -1;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.5));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            flex: 1;
        }

        .chat-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .chat-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .dobby-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .chat-info h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 500px;
            max-height: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: messageSlide 0.4s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .assistant .message-avatar {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .user .message-content {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-bottom-right-radius: 6px;
        }

        .assistant .message-content {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 6px;
        }

        .job-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.2);
        }

        .job-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--warning), var(--secondary));
        }

        .job-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .job-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .job-company {
            color: var(--warning);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .job-location {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .job-salary {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }

        .job-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .job-link {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .job-link:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }

        .strategy-card {
            background: linear-gradient(135d, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }

        .strategy-title {
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .strategy-content {
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Dobby Response Formatting */
        .strategy-content h1,
        .strategy-content h2,
        .strategy-content h3,
        .strategy-content h4,
        .strategy-content h5,
        .strategy-content h6 {
            font-weight: 700;
            color: var(--primary);
            margin: 20px 0 10px 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 5px;
        }

        .strategy-content h1 { font-size: 1.4rem; }
        .strategy-content h2 { font-size: 1.3rem; }
        .strategy-content h3 { font-size: 1.2rem; }
        .strategy-content h4 { font-size: 1.1rem; }

        .strategy-content strong {
            font-weight: 700;
            color: var(--secondary);
        }

        .strategy-content ul, .strategy-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .strategy-content li {
            margin: 5px 0;
            line-height: 1.5;
        }

        .strategy-content p {
            margin: 10px 0;
        }

        .strategy-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 20px 0;
        }

        /* Message content formatting */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            font-weight: 700;
            color: var(--primary);
            margin: 15px 0 8px 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 3px;
        }

        .message-content h1 { font-size: 1.3rem; }
        .message-content h2 { font-size: 1.2rem; }
        .message-content h3 { font-size: 1.1rem; }
        .message-content h4 { font-size: 1.05rem; }

        .message-content strong {
            font-weight: 700;
            color: var(--secondary);
        }

        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 18px;
        }

        .message-content li {
            margin: 4px 0;
            line-height: 1.4;
        }

        .message-content p {
            margin: 8px 0;
        }

        .message-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 15px 0;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
            font-style: italic;
            padding: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-input {
            padding: 20px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
        }

        .suggestions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .suggestion-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .suggestion-chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .input-container {
            position: relative;
            display: flex;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: var(--glow);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 20px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quick-action {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-align: left;
        }

        .quick-action:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .recent-searches {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-search {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recent-search:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
                gap: 15px;
            }

            .header {
                padding: 20px;
            }

            .title {
                font-size: 2rem;
            }

            .logo {
                font-size: 3rem;
            }

            .message-content {
                max-width: 85%;
            }

            .suggestions {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Loading animations */
        .loading {
            opacity: 0.7;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Error states */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        /* Success states */
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--success);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
    <div class="header-content">
        <img src="dobby-logo.png" alt="Dobby Logo" class="logo" style="width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.5)); animation: float 3s ease-in-out infinite;">
        <h1 class="title">Dobby AI Jobber</h1>
        <p class="subtitle">Your Advanced Career Intelligence Assistant</p>
        <div class="status-badge">
            <div class="status-dot"></div>
            <span>AI Ready ‚Ä¢ Job Search Active</span>
        </div>
    </div>
</header>

        <main class="main-content">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="dobby-avatar">
                        <img src="dobby-logo.png" alt="Dobby Logo" style="width: 40px; height: 40px; object-fit: contain; border-radius: 50%; box-shadow: 0 0 8px rgba(139,92,246,0.2); background: #fff;">
                    </div>
                    <div class="chat-info">
                        <h3>Dobby Assistant</h3>
                        <p>Specialized in career guidance and job placement</p>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message">
                            <img src="dobby-logo.png" alt="Dobby Logo" style="width: 40px; height: 40px; object-fit: contain; border-radius: 50%; box-shadow: 0 0 8px rgba(139,92,246,0.2); background: #fff;">
                        </div>
                        <div class="message-content">
                            <strong>Welcome to Dobby AI Jobber!</strong><br><br>
                            I'm your advanced career assistant, ready to help you find your dream job and land it successfully. Here's what I can do for you:<br><br>
                            ‚Ä¢ <strong>Smart Job Search</strong> - Find relevant positions based on your skills<br>
                            ‚Ä¢ <strong>Application Strategy</strong> - Get personalized advice for each role<br>
                            ‚Ä¢ <strong>Career Guidance</strong> - Resume tips, interview prep, and more<br>
                            ‚Ä¢ <strong>Company Insights</strong> - Learn how to stand out to employers<br><br>
                            Try saying: <em>"Hey Dobby, find Software Engineering jobs around me"</em> or <em>"Help me with interview preparation"</em>
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <div class="suggestions">
                        <div class="suggestion-chip" onclick="sendSuggestion('Find software engineering jobs')">
                            üíª Tech Jobs
                        </div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Find marketing jobs')">
                            üìà Marketing
                        </div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Help with resume')">
                            üìÑ Resume Help
                        </div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Interview preparation tips')">
                            üé§ Interview Prep
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Ask Dobby anything about your career..."
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-chart-bar"></i>
                        Session Stats
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="jobsFound">0</span>
                            <div class="stat-label">Jobs Found</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="strategiesGenerated">0</span>
                            <div class="stat-label">Strategies</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="messagesExchanged">1</span>
                            <div class="stat-label">Messages</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="companiesAnalyzed">0</span>
                            <div class="stat-label">Companies</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-bolt"></i>
                        Quick Actions
                    </h3>
                    <div class="quick-actions">
                        <div class="quick-action" onclick="sendSuggestion('Find remote jobs')">
                            üåê Remote Opportunities
                        </div>
                        <div class="quick-action" onclick="sendSuggestion('High Paying Jobs')">
                            üí∞ High-Pay Jobs
                        </div>
                        <div class="quick-action" onclick="sendSuggestion('Official Jobs')">
                            üíº Official Jobs
                        </div>
                        <div class="quick-action" onclick="sendSuggestion('Thinking Of New Jobs')">
                            üí° New Jobs
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-history"></i>
                        Recent Searches
                    </h3>
                    <div class="recent-searches" id="recentSearches">
                        <div class="recent-search">No recent searches yet</div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            DOBBY_KEY: process.env.NEXT_PUBLIC_DOBBY_API_KEY,
            API_JOB: process.env.NEXT_PUBLIC_API_JOB_KEY,
            MAX_JOBS: 10,
            TYPING_DELAY: 1500,
            MESSAGE_DELAY: 500
        };

        // State management
        const state = {
            isLoading: false,
            jobsFound: 0,
            strategiesGenerated: 0,
            messagesExchanged: 1,
            companiesAnalyzed: 0,
            recentSearches: [],
            currentConversation: [],
            waitingForJobPosition: false,      
            waitingForInterviewPosition: false 
        };

        var Max_Tokens = 0;

        // DOM elements
        const elements = {
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            jobsFoundStat: document.getElementById('jobsFound'),
            strategiesStat: document.getElementById('strategiesGenerated'),
            messagesStat: document.getElementById('messagesExchanged'),
            companiesStat: document.getElementById('companiesAnalyzed'),
            recentSearches: document.getElementById('recentSearches')
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            autoResizeTextarea();
            loadRecentSearches();
        }

        function setupEventListeners() {
            elements.messageInput.addEventListener('keydown', handleKeyPress);
            elements.messageInput.addEventListener('input', autoResizeTextarea);
            
            // Add paste event listener for better UX
            elements.messageInput.addEventListener('paste', (e) => {
                setTimeout(autoResizeTextarea, 10);
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResizeTextarea() {
            const textarea = elements.messageInput;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // ...existing code...

async function sendMessage() {
    const message = elements.messageInput.value.trim();
    if (!message || state.isLoading) return;

    // Add user message
    addMessage(message, 'user');
    elements.messageInput.value = '';
    autoResizeTextarea();
    updateStats({ messagesExchanged: state.messagesExchanged + 1 });
    setLoading(true);

    try {
        // Check for specific keywords and handle accordingly
        const lowerMessage = message.toLowerCase();
        
        // Job search keywords
        const jobKeywords = ['job', 'jobs', 'position', 'positions', 'opening', 'openings', 'employment', 'career', 'vacancy', 'vacancies', 'work', 'hiring'];
        const isJobSearch = jobKeywords.some(keyword => lowerMessage.includes(keyword));
        
        // Interview keywords
        const interviewKeywords = ['interview', 'interviewing', 'interview prep', 'interview preparation', 'interview tips'];
        const isInterview = interviewKeywords.some(keyword => lowerMessage.includes(keyword));
        
        // Resume keywords
        const resumeKeywords = ['resume', 'cv', 'resume building', 'resume tips', 'curriculum vitae'];
        const isResume = resumeKeywords.some(keyword => lowerMessage.includes(keyword));
        
        // Job tips keywords
        const jobTipsKeywords = ['job tips', 'career tips', 'job advice', 'career advice', 'job help'];
        const isJobTips = jobTipsKeywords.some(keyword => lowerMessage.includes(keyword));

        if (isJobSearch && !state.waitingForJobPosition) {
            // Handle job search
            state.waitingForJobPosition = true;
            const response = "What specific position are you looking for? (e.g., Community Manager, React Developer, FullStack Developer, etc.)";
            addMessage(response, 'assistant');
            setLoading(false);
            return;
        }
        
        if (state.waitingForJobPosition) {
            // User provided job position, fetch jobs from API
            state.waitingForJobPosition = false;
            await handleJobSearch(message);
            setLoading(false);
            return;
        }
        
        if (isInterview && !state.waitingForInterviewPosition) {
            // Handle interview preparation
            state.waitingForInterviewPosition = true;
            const response = "What position are you interviewing for? (e.g., Community Manager, React Developer, FullStack Developer, etc.)";
            addMessage(response, 'assistant');
            setLoading(false);
            return;
        }
        
        if (state.waitingForInterviewPosition) {
            // User provided interview position, get interview guide from Dobby
            state.waitingForInterviewPosition = false;
            Max_Tokens = 450;
            await handleInterviewPrep(message);
            setLoading(false);
            return;
        }
        
        if (isResume) {
            // Handle resume building
            Max_Tokens = 450;
            await handleResumeBuilding(message);
            setLoading(false);
            return;
        }
        
        if (isJobTips) {
            // Handle job tips
            Max_Tokens = 450;
            await handleJobTips(message);
            setLoading(false);
            return;
        }

        // Default: send to Dobby for general conversation
        showTypingIndicator();
        Max_Tokens = 450;
        const dobbyResponse = await getDobbyResponse(message);
        hideTypingIndicator();
        addMessage(dobbyResponse.replace(/["#'-]+/g, ''), 'assistant', null, true);

    } catch (error) {
        console.error('Error processing message:', error);
        hideTypingIndicator();
        addMessage(`Error: ${error.message}. Please try again.`, 'assistant', 'error-message');
    } finally {
        setLoading(false);
    }
}

// Handler for job search functionality
async function handleJobSearch(position) {
    try {
        showTypingIndicator(`Searching for ${position} jobs...`);
        console.log(position);

        // Fetch jobs from JobAPI.dev
        const response = await fetch('https://api.apijobs.dev/v1/job/search', {
            method: 'POST',
            headers: {
                'apikey': CONFIG.API_JOB,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "q": position,
                "size": 5
            })
        });

        if (!response.ok) {
            throw new Error('Failed to fetch jobs from API');
        }
        
        
        const data = await response.json();
        console.log(data)
        const jobs = data.hits || [];
        
        hideTypingIndicator();

        if (!jobs.length) {
            addMessage(`No ${position} jobs found. Try a different position.`, 'assistant', 'error-message');
            return;
        }

        // Display jobs
        addMessage(`Found ${jobs.length} ${position} opportunities:`, 'assistant', 'success-message');
        
        for (const job of jobs) {
            const jobHtml = createJobCard(job);
            addMessage(jobHtml, 'assistant', null, true);
            
            // Get Dobby's strategy for each job
            await getDobbyJobStrategy(job, position);
        }

        // Update stats
        updateStats({
            jobsFound: state.jobsFound + jobs.length,
            companiesAnalyzed: state.companiesAnalyzed + new Set(jobs.map(j => j.company)).size
        });

    } catch (error) {
        hideTypingIndicator();
        addMessage(`Error fetching jobs: ${error.message}`, 'assistant', 'error-message');
    }
}

// Handler for interview preparation
async function handleInterviewPrep(position) {
    try {
        showTypingIndicator(`Preparing interview guide for ${position}...`);
        
        const interviewPrompt = `As Dobby, a professional career advisor, provide a detailed interview preparation guide for a ${position} position. Be formal and direct. Include:

1. Common interview questions for this role
2. Technical questions specific to ${position}
3. How to research the company
4. What to prepare beforehand
5. Questions to ask the interviewer
6. Professional tips for success

Format as a structured guide. Be concise and actionable.`;

        const dobbyResponse = await getDobbyResponse(interviewPrompt);
        
        hideTypingIndicator();
        
        const guideHtml = `
            <div class="strategy-card">
                <div class="strategy-title">
                    <i class="fas fa-user-tie"></i>
                    Interview Guide: ${position}
                </div>
                <div class="strategy-content">${formatDobbyResponse(dobbyResponse)}</div>
            </div>
        `;
        
        addMessage(guideHtml, 'assistant', null, true);
        updateStats({ strategiesGenerated: state.strategiesGenerated + 1 });
        
    } catch (error) {
        hideTypingIndicator();
        addMessage(`Error generating interview guide: ${error.message}`, 'assistant', 'error-message');
    }
}

// Handler for resume building
async function handleResumeBuilding(message) {
    try {
        showTypingIndicator("Generating resume building guide...");
        
        const resumePrompt = `As Dobby, a professional career advisor, provide specific resume building advice based on this request: "${message}". Be formal and direct. Include:

1. Resume structure and format
2. Key sections to include
3. How to write impactful bullet points
4. Skills section optimization
5. Common mistakes to avoid
6. ATS optimization tips

IMPORTANT:
- Be direct and specific
- Use clear section headers
- Keep each section focused and concise
- Use markdown formatting for readability
- Provide actionable, non-repetitive insights
- Do not include greetings or sign-offs


Be concise and actionable. No unnecessary words.`;

        const dobbyResponse = await getDobbyResponse(resumePrompt);
        
        hideTypingIndicator();
        
        const guideHtml = `
            <div class="strategy-card">
                <div class="strategy-title">
                    <i class="fas fa-file-alt"></i>
                    Resume Building Guide
                </div>
                <div class="strategy-content">${formatDobbyResponse(dobbyResponse)}</div>
            </div>
        `;
        
        addMessage(guideHtml, 'assistant', null, true);
        updateStats({ strategiesGenerated: state.strategiesGenerated + 1 });
        
    } catch (error) {
        hideTypingIndicator();
        addMessage(`Error generating resume guide: ${error.message}`, 'assistant', 'error-message');
    }
}

// Handler for job tips
async function handleJobTips(message) {
    try {
        showTypingIndicator("Generating job search tips...");
        
        const tipsPrompt = `As Dobby, a professional career advisor, provide specific job search tips based on this request: "${message}". Be formal and direct. Include:

1. Job search strategies
2. Networking approaches
3. Application optimization
4. Interview preparation
5. Follow-up techniques
6. Salary negotiation basics

Be concise and actionable. No unnecessary words.`;

        const dobbyResponse = await getDobbyResponse(tipsPrompt);
        
        hideTypingIndicator();
        
        const guideHtml = `
            <div class="strategy-card">
                <div class="strategy-title">
                    <i class="fas fa-lightbulb"></i>
                    Job Search Tips
                </div>
                <div class="strategy-content">${formatDobbyResponse(dobbyResponse)}</div>
            </div>
        `;
        
        addMessage(guideHtml, 'assistant', null, true);
        updateStats({ strategiesGenerated: state.strategiesGenerated + 1 });
        
    } catch (error) {
        hideTypingIndicator();
        addMessage(`Error generating job tips: ${error.message}`, 'assistant', 'error-message');
    }
}

// Get job-specific strategy from Dobby
async function getDobbyJobStrategy(job, position) {
    try {
        const strategyPrompt = `TASK: Analyze this job posting and provide a comprehensive application strategy.

JOB DATA:
Company: ${job.hiring_organization_name || 'N/A'}
Position: ${job.title || position}
Location: ${job.city + ", " + job.country || 'N/A'}

STRATEGY REQUIREMENTS:
Provide exactly 5 sections in this order:

1. Application Customization
- Tailoring resume and cover letter
- Specific adjustments for this role

2. Key Skills to Emphasize
- Core technical and soft skills
- How they align with the job requirements

3. Company Research Points
- Critical aspects to learn about the company
- Industry insights to highlight

4. Interview Preparation
- Likely questions and themes
- Best preparation methods

5. Follow-Up Strategy
- Post-application and post-interview actions
- Professional communication style

IMPORTANT:
- Be direct and specific
- Use clear section headers
- Keep each section focused and concise
- Use markdown formatting for readability
- Provide actionable, non-repetitive insights
- Stop after section 5
- Do not include greetings or sign-offs`;


        //const dobbyResponse = await getDobbyResponse(strategyPrompt);
        //
            const response = await fetch("https://api.fireworks.ai/inference/v1/completions", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${CONFIG.DOBBY_KEY}`
                },
                body: JSON.stringify({
                    model: "accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b",
                    max_tokens: 600,
                    top_p: 0.9,
                    top_k: 40,
                    presence_penalty: 0.3,
                    frequency_penalty: 0.3,
                    temperature: 0.7,
                    prompt: strategyPrompt,
                })
            });

            if (!response.ok) {
                throw new Error(`Dobby API request failed: ${response.status}`);
            }

            const data = await response.json();
            // Enhanced response parsing - try multiple possible response structures
            let analysis = '';
            
            if (data.choices && data.choices[0]) {
            if (data.choices[0].text) {
                analysis = data.choices[0].text.trim();
            } else if (data.choices[0].message && data.choices[0].message.content) {
                analysis = data.choices[0].message.content.trim();
            }
            } else if (data.text) {
            analysis = data.text.trim();
            } else if (data.response) {
            analysis = data.response.trim();
            } else if (data.content) {
            analysis = data.content.trim();
            }
            
            console.log("üîç Raw API response structure:", data);
            console.log("üìù Extracted analysis:", analysis);
            
            if (!analysis || analysis.length < 10) {
            log(`‚ùå Invalid analysis response. Raw data: ${JSON.stringify(data).substring(0, 200)}...`, 'error');
            throw new Error(`Empty or invalid analysis response. Length: ${analysis?.length || 0}`);
            }
        //

        const strategyHtml = `
            <div class="strategy-card">
                <div class="strategy-title">
                    <i class="fas fa-target"></i>
                    Strategy: ${job.title} at ${job.hiring_organization_name}
                </div>
                <div class="strategy-content">${formatDobbyResponse(analysis)}</div>
            </div>
        `;
        
        addMessage(strategyHtml, 'assistant', null, true);
        updateStats({ strategiesGenerated: state.strategiesGenerated + 1 });
        
    } catch (error) {
        console.error('Strategy generation error:', error);
        addMessage(`Quick Strategy: Research ${job.company}, customize your application, and prepare specific examples.`, 'assistant');
    }
}

function formatDobbyResponse(text) {
    // Clean up the response first
    let formatted = text
        .replace(/(Best regards,|Best,|Hope this helps!|Let me know if you need more advice|Career Advisor & Job Placement Specialist|Dobby)/gi, '')
        .replace(/(-{2,}|={2,})/g, '') // Remove lines with only dashes or equals
        .replace(/(\n\s*){3,}/g, '\n\n') // Collapse multiple newlines
        .trim();

    // Convert markdown-style formatting to HTML
    formatted = formatted
        // Headers with ### format
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        
        // Headers with underlines (like in your examples)
        .replace(/^(.+)\n={3,}$/gm, '<h1>$1</h1>')
        .replace(/^(.+)\n-{3,}$/gm, '<h2>$1</h2>')
        
        // Bold section headers (like "1. Application Customization")
        .replace(/^(\d+\.\s*)([^:\n]+)$/gm, '<h3>$1$2</h3>')
        
        // Bold text with **text** or __text__
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')
        
        // Italic text with *text* or _text_
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/_([^_]+)_/g, '<em>$1</em>')
        
        // Bullet points with * or -
        .replace(/^[\*\-] (.+)$/gm, '<li>$1</li>')
        
        // Numbered lists
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        
        // Add proper paragraph breaks for double line breaks
        .replace(/\n\n/g, '</p><p>')
        
        // Convert single line breaks to <br> tags
        .replace(/\n/g, '<br>');

    // Wrap consecutive <li> elements in <ul> tags
    formatted = formatted.replace(/(<li>.*?<\/li>)(<br>)*(?=<li>|$)/gs, function(match, li, br) {
        return li;
    });
    
    // Group list items into proper ul/ol tags
    formatted = formatted.replace(/(<li>.*?<\/li>(<br>)*)+/gs, function(match) {
        const items = match.replace(/<br>/g, '');
        return '<ul>' + items + '</ul>';
    });

    // Wrap content in paragraphs if not already wrapped
    if (!formatted.startsWith('<h') && !formatted.startsWith('<p>')) {
        formatted = '<p>' + formatted + '</p>';
    }

    return formatted;
}

function cleanDobbyResponse(text) {
    // This function is kept for backward compatibility
    return formatDobbyResponse(text);
}

// Helper function to create job card HTML
function createJobCard(job) {

    return `
        <div class="job-card">
            <div class="job-header">
                <div>
                    <div class="job-title">${job.title || 'N/A'}</div>
                    <div class="job-company">${job.hiring_organization_name || 'N/A'}</div>
                   ${job.city ? `<div class="job-location">${job.city + ", " + job.country|| 'N/A'}</div>` : job.country}
                    ${job.employment_type ? `<div class="job-salary">${job.employment_type}</div>` : ''}
                </div>
            </div>
            <div class="job-actions">
                <a href="${job.url || '#'}" target="_blank" class="job-link">
                    <i class="fas fa-external-link-alt"></i>
                    Apply Now
                </a>
            </div>
        </div>
    `;
}


        function detectJobSearchIntent(message) {
            const jobKeywords = ['find jobs', 'search jobs', 'job opportunities', 'looking for work', 'job search', 'hiring', 'careers', 'openings', 'positions', 'employment'];
            const roleKeywords = ['engineer', 'developer', 'designer', 'manager', 'analyst', 'consultant', 'teacher', 'nurse', 'accountant', 'marketing', 'sales', 'hr', 'admin', 'finance', 'product', 'data scientist', 'ui/ux', 'frontend', 'backend', 'fullstack'];
            
            const lowerMessage = message.toLowerCase();
            const isJobSearch = jobKeywords.some(keyword => lowerMessage.includes(keyword));
            const hasSpecificRole = roleKeywords.some(role => lowerMessage.includes(role));
            
            let detectedRole = '';
            if (hasSpecificRole) {
                detectedRole = roleKeywords.find(role => lowerMessage.includes(role));
            }

            return {
                isJobSearch,
                hasSpecificRole,
                role: detectedRole
            };
        }

        async function generateClarificationResponse(message) {
            const clarificationPrompts = [
                "I'd love to help you find the perfect job! What type of role are you interested in? For example: Software Engineer, Marketing Manager, Data Analyst, etc.",
                "Great! I can search for jobs for you. Could you specify what kind of position you're looking for? (e.g., Developer, Designer, Sales, etc.)",
                "I'm ready to find amazing opportunities for you! What's your target role or industry?",
                "Perfect timing for a job search! What type of position would you like me to look for?"
            ];

            return clarificationPrompts[Math.floor(Math.random() * clarificationPrompts.length)];
        }

        async function getDobbyResponse(message) {
            const systemPrompt = `You are Dobby, a professional career advisor and job placement specialist.

            IMPORTANT:
            - Be formal and professional in tone
            - Get straight to the point - no unnecessary words or fluff  
            - Provide specific, actionable advice only
            - Use concise, structured responses
            - No casual language or overly friendly tone
            - Focus on practical career guidance
            - Avoid repetition and redundant phrases

            User message: "${message}"

            Provide a direct, professional response:`;

            const response = await fetch("https://api.fireworks.ai/inference/v1/completions", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${CONFIG.DOBBY_KEY}`
                },
                body: JSON.stringify({
                    model: "accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b",
                    max_tokens: Max_Tokens,
                    top_p: 0.9,
                    top_k: 40,
                    presence_penalty: 0.3,
                    frequency_penalty: 0.3,
                    temperature: 0.7,
                    prompt: systemPrompt,
                })
            });

            if (!response.ok) {
                throw new Error(`Dobby API request failed: ${response.status}`);
            }

            const data = await response.json();
            // Enhanced response parsing - try multiple possible response structures
            let analysis = '';
            
            if (data.choices && data.choices[0]) {
            if (data.choices[0].text) {
                analysis = data.choices[0].text.trim();
            } else if (data.choices[0].message && data.choices[0].message.content) {
                analysis = data.choices[0].message.content.trim();
            }
            } else if (data.text) {
            analysis = data.text.trim();
            } else if (data.response) {
            analysis = data.response.trim();
            } else if (data.content) {
            analysis = data.content.trim();
            }
            
            console.log("üîç Raw API response structure:", data);
            console.log("üìù Extracted analysis:", analysis);

            return analysis;
            
            if (!analysis || analysis.length < 10) {
            log(`‚ùå Invalid analysis response. Raw data: ${JSON.stringify(data).substring(0, 200)}...`, 'error');
            throw new Error(`Empty or invalid analysis response. Length: ${analysis?.length || 0}`);
            }
        }

        async function searchAndDisplayJobs(role, originalMessage) {
            try {
                showTypingIndicator("üîç Searching for " + role + " positions...");
                
                // Using JobAPI.dev (you'll need to replace with actual API)
                const jobs = await fetchJobsFromAPI(role);
                
                hideTypingIndicator();
                
                if (!jobs || jobs.length === 0) {
                    addMessage(`‚ùå I couldn't find any ${role} positions at the moment. Try different keywords or check back later!`, 'assistant');
                    return;
                }

                // Display job search results
                const jobCount = Math.min(jobs.length, CONFIG.MAX_JOBS);
                addMessage(`üéØ <strong>Found ${jobCount} ${role} opportunities!</strong> Here are the best matches:`, 'assistant', 'success-message');

                // Display each job
                for (let i = 0; i < jobCount; i++) {
                    await displayJob(jobs[i], i);
                    await new Promise(resolve => setTimeout(resolve, 300)); // Stagger display
                }

                // Update stats
                updateStats({
                    jobsFound: state.jobsFound + jobCount,
                    companiesAnalyzed: state.companiesAnalyzed + new Set(jobs.map(job => job.company)).size
                });

                // Provide additional guidance
                setTimeout(() => {
                    addMessage(`üí° <strong>Next Steps:</strong><br>
                    ‚Ä¢ Review each position carefully<br>
                    ‚Ä¢ Customize your applications for each company<br>
                    ‚Ä¢ Use the strategies I've provided<br>
                    ‚Ä¢ Follow up professionally after applying<br><br>
                    Need help with anything else? I can assist with resume optimization, interview prep, or salary negotiation!`, 'assistant');
                }, 1000);

            } catch (error) {
                console.error('Job search error:', error);
                hideTypingIndicator();
                addMessage(`‚ùå <strong>Job Search Error:</strong> ${error.message}. Please try again with different keywords.`, 'assistant', 'error-message');
            }
        }

        async function fetchJobsFromAPI(role) {
            // Mock job data for demonstration - replace with actual API call
            const mockJobs = [
                {
                    title: `Senior ${role}`,
                    company: "TechCorp Solutions",
                    location: "Lagos, Nigeria",
                    salary: "$80,000 - $120,000",
                    url: "https://example.com/job1",
                    description: `We are looking for an experienced ${role} to join our dynamic team...`,
                    requirements: ["5+ years experience", "Strong problem-solving skills", "Team collaboration"],
                    posted: "2 days ago"
                },
                {
                    title: `${role} - Remote`,
                    company: "InnovateHub",
                    location: "Remote (Nigeria)",
                    salary: "$60,000 - $90,000",
                    url: "https://example.com/job2",
                    description: `Join our remote-first team as a ${role}...`,
                    requirements: ["3+ years experience", "Remote work experience", "Strong communication"],
                    posted: "1 week ago"
                },
                {
                    title: `Lead ${role}`,
                    company: "StartupXYZ",
                    location: "Abuja, Nigeria",
                    salary: "$90,000 - $130,000",
                    url: "https://example.com/job3",
                    description: `We're seeking a lead ${role} to drive our technical vision...`,
                    requirements: ["7+ years experience", "Leadership experience", "Technical expertise"],
                    posted: "3 days ago"
                }
            ];

            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            return mockJobs;
        }

        async function displayJob(job, index) {
            const jobHtml = `
                <div class="job-card">
                    <div class="job-header">
                        <div>
                            <div class="job-title">üíº ${job.title}</div>
                            <div class="job-company">üè¢ ${job.company}</div>
                            <div class="job-location">üìç ${job.location}</div>
                            ${job.salary ? `<div class="job-salary">üí∞ ${job.salary}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="job-actions">
                        <a href="${job.url}" target="_blank" class="job-link">
                            <i class="fas fa-external-link-alt"></i>
                            Apply Now
                        </a>
                    </div>
                </div>
            `;
            
            addMessage(jobHtml, 'assistant', null, true);
            
            // Generate strategy after a short delay
            setTimeout(async () => {
                await generateJobStrategy(job);
            }, 500);
        }

        async function generateJobStrategy(job) {
            try {
                const strategyPrompt = `As Dobby, a professional career advisor, provide a specific strategy for landing this ${position} job. Be formal and direct:

Company: ${job.hiring_organization_name || 'N/A'}
Position: ${job.title || position}
Location: ${job.city + ", " + job.country || 'N/A'}

Provide 4-5 actionable tips:
1. Application customization
2. Key skills to emphasize  
3. Company research points
4. Interview preparation specifics
5. Follow-up strategy

Be concise. No unnecessary words.`;
                const response = await fetch("https://api.fireworks.ai/inference/v1/completions", {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${CONFIG.DOBBY_KEY}`
                    },
                    body: JSON.stringify({
                        model: "accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b",
                        max_tokens: 400,
                        top_p: 0.8,
                        top_k: 40,
                        presence_penalty: 0.2,
                        frequency_penalty: 0.2,
                        temperature: 0.3,
                        prompt: strategyPrompt
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const strategy = data.choices[0].text.trim();
                    
                    const strategyHtml = `
    <div class="strategy-card">
        <div class="strategy-title">
            <i class="fas fa-target"></i>
            Strategy: ${job.title} at ${job.hiring_organization_name || 'N/A'}
        </div>
        <div class="strategy-content">${cleanDobbyResponse(dobbyResponse).replace(/\n/g, '<br>')}</div>
    </div>
`;
                    
                    addMessage(strategyHtml, 'assistant', null, true);
                    updateStats({ strategiesGenerated: state.strategiesGenerated + 1 });
                }
            } catch (error) {
                console.error('Strategy generation error:', error);
                addMessage(`üí° <strong>Quick Strategy:</strong> Research ${job.company} thoroughly, highlight relevant experience in your application, and prepare specific examples that match their requirements.`, 'assistant');
            }
        }

        function addMessage(content, sender, additionalClass = null, isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            if (sender === 'user') {
                avatarDiv.textContent = 'üë§';
            } else {
                const img = document.createElement('img');
                img.src = 'dobby-logo.png';
                img.alt = 'Dobby Logo';
                img.style.width = '40px';
                img.style.height = '40px';
                img.style.objectFit = 'contain';
                img.style.borderRadius = '50%';
                img.style.boxShadow = '0 0 8px rgba(139,92,246,0.2)';
                img.style.background = '#fff';
                avatarDiv.appendChild(img);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${additionalClass || ''}`;
            
            if (isHtml) {
                contentDiv.innerHTML = content;
            } else {
                contentDiv.innerHTML = content.replace(/\n/g, '<br>');
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            elements.chatMessages.appendChild(messageDiv);
            
            // Animate message appearance
            setTimeout(() => {
                messageDiv.style.animation = 'messageSlide 0.4s ease-out forwards';
            }, 50);
            
            scrollToBottom();
        }

        function showTypingIndicator(customText = "Dobby is thinking...") {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <img src="dobby-logo.png" alt="Dobby Logo" style="width: 40px; height: 40px; object-fit: contain; border-radius: 50%; box-shadow: 0 0 8px rgba(139,92,246,0.2); background: #fff;">
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span>${customText}</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            elements.chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function setLoading(loading) {
            state.isLoading = loading;
            elements.sendButton.disabled = loading;
            elements.messageInput.disabled = loading;
            
            if (loading) {
                elements.sendButton.innerHTML = '<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
                elements.sendButton.classList.add('loading');
            } else {
                elements.sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                elements.sendButton.classList.remove('loading');
            }
        }

        function updateStats(updates) {
            Object.keys(updates).forEach(key => {
                if (state[key] !== undefined) {
                    state[key] = updates[key];
                    const element = elements[key + 'Stat'] || document.getElementById(key);
                    if (element) {
                        element.textContent = state[key];
                        element.classList.add('pulse');
                        setTimeout(() => element.classList.remove('pulse'), 1000);
                    }
                }
            });
        }

        function addToRecentSearches(searchTerm) {
            if (!state.recentSearches.includes(searchTerm)) {
                state.recentSearches.unshift(searchTerm);
                if (state.recentSearches.length > 5) {
                    state.recentSearches.pop();
                }
                updateRecentSearchesDisplay();
                saveRecentSearches();
            }
        }

        function updateRecentSearchesDisplay() {
            elements.recentSearches.innerHTML = '';
            
            if (state.recentSearches.length === 0) {
                elements.recentSearches.innerHTML = '<div class="recent-search">No recent searches yet</div>';
                return;
            }
            
            state.recentSearches.forEach(search => {
                const searchDiv = document.createElement('div');
                searchDiv.className = 'recent-search';
                searchDiv.textContent = search;
                searchDiv.onclick = () => sendSuggestion(`Find ${search} jobs`);
                elements.recentSearches.appendChild(searchDiv);
            });
        }

        function saveRecentSearches() {
            localStorage.setItem('dobby_recent_searches', JSON.stringify(state.recentSearches));
        }

        function loadRecentSearches() {
            // In a real app, you'd load from localStorage or backend
            const saved = localStorage.getItem('dobby_recent_searches');
            if (saved) {
                state.recentSearches = JSON.parse(saved);
                 updateRecentSearchesDisplay();
            }
        }

        function sendSuggestion(suggestion) {
            elements.messageInput.value = suggestion;
            elements.messageInput.focus();
            autoResizeTextarea();
        }

        function scrollToBottom() {
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);

        // Add some easter eggs and advanced features
        function addEasterEggs() {
            // Konami code easter egg
            let konamiCode = [];
            const konami = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];
            
            document.addEventListener('keydown', (e) => {
                konamiCode.push(e.keyCode);
                if (konamiCode.length > 10) konamiCode.shift();
                
                if (konamiCode.join(',') === konami.join(',')) {
                    addMessage("üéâ <strong>Easter Egg Activated!</strong> You found the secret! Dobby's magical powers are now at maximum level! ‚ú®", 'assistant', 'success-message');
                    konamiCode = [];
                }
            });
        }

        // Advanced features
        function enableAdvancedFeatures() {
            // Voice recognition (if supported)
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                addVoiceRecognition();
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    elements.messageInput.focus();
                }
            });
        }

        function addVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            // Add voice button to input
            const voiceButton = document.createElement('button');
            voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceButton.className = 'voice-button';
            voiceButton.style.cssText = `
                position: absolute;
                right: 60px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: var(--text-muted);
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                transition: all 0.3s ease;
            `;
            
            voiceButton.addEventListener('click', () => {
                recognition.start();
                voiceButton.innerHTML = '<i class="fas fa-circle" style="color: var(--error); animation: pulse 1s infinite;"></i>';
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                elements.messageInput.value = transcript;
                autoResizeTextarea();
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            };

            recognition.onerror = () => {
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            };

            elements.messageInput.parentElement.style.position = 'relative';
            elements.messageInput.parentElement.appendChild(voiceButton);
        }

        // Initialize advanced features
        setTimeout(() => {
            addEasterEggs();
            enableAdvancedFeatures();
        }, 1000);
    </script>
</body>

</html>
